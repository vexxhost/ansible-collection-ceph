# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Adopt Ceph cluster
  when:
    - inventory_hostname == groups[ceph_mon_group][0]
  block:
    - name: Get ceph state
      ansible.builtin.command: cephadm shell -- ceph orch status
      ignore_errors: true
      register: orch_status_result
      changed_when: false

    # current cluster is not cephadm backend, requires to convert to cephadm
    - name: Prepare hosts for cephadm backend
      when: "'Backend: cephadm' not in orch_status_result.stdout"
      block:
        # This task requires all hosts to have cephadm ready in place
        - name: Run prepare host
          delegate_to: "{{ item }}"
          ansible.builtin.command: cephadm prepare-host
          loop: "{{ play_hosts }}"
          changed_when: false

        - name: Wait for prepare host process complete
          ansible.builtin.command: cephadm ls
          register: convert_status
          until: >
            '"style": "legacy"' not in convert_status.stdout
          retries: 120
          delay: 5
          changed_when: false
          failed_when: convert_status.rc > 1

    - name: Assimilate exists configs in `ceph.conf`
      ansible.builtin.command: cephadm shell --fsid "{{ ceph_mon_fsid }}" -- ceph config assimilate-conf -i /etc/ceph/ceph.conf
      changed_when: false

    - name: Adopt monitor to cluster
      throttle: 1
      ansible.builtin.command:
        cmd: |
          cephadm adopt --style legacy --legacy-dir "{{ ceph_legacy_dir }}" --name "mon.{{ item }}"
      loop: "{{ groups[ceph_mon_group] }}"
      changed_when: false

    - name: Adopt manager to cluster
      throttle: 1
      ansible.builtin.command:
        cmd: |
          cephadm adopt --style legacy --legacy-dir "{{ ceph_legacy_dir }}" --name "mgr.{{ item }}"
      loop: "{{ groups[ceph_mon_group] }}"
      changed_when: false

    - name: Ceph mgr module enable cephadm
      ansible.builtin.command: cephadm shell -- ceph mgr module enable cephadm
      changed_when: false

    - name: Ceph orch set backend cephadm
      ansible.builtin.command: cephadm shell -- ceph orch set backend cephadm
      changed_when: false

    - name: Use `cephadm` user for cephadm
      ansible.builtin.command: cephadm shell -- ceph cephadm set-user cephadm
      changed_when: false

    - name: Ceph cephadm generate-key
      ansible.builtin.command: cephadm shell -- ceph cephadm generate-key
      changed_when: false

- name: Validate monitor adoption
  ansible.builtin.command: cephadm shell -- ceph orch ps
  register: ps_result
  until: >
    "mon.{{ inventory_hostname_short }}" in ps_result.stdout
  retries: 120
  delay: 5
  changed_when: false
  failed_when: ps_result.rc > 1
