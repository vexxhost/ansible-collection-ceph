# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Adopt Ceph cluster
  when:
    - inventory_hostname == groups[ceph_mon_group][0]
  block:
    - name: Get ceph state
      ansible.builtin.command: cephadm shell -- ceph orch status
      ignore_error: true
      register: orch_status_result

    # current cluster is not cephadm backend, requires to convert to cephadm
    - name: Prepare adopting
      ansible.builtin.include_tasks: prepare-adopt.yml
      when: "'Backend: cephadm' not in orch_status_result.stdout"

    - name: Assimilate existing configs
      ansible.builtin.command: cephadm shell -- ceph config assimilate-conf -i /etc/ceph/ceph.config

    - name: Adopt monitor to cluster
      throttle: 1
      ansible.builtin.command:
        cmd: |
          cephadm adopt --style legacy --name "mon.{{ item }}"
      loop: groups[ceph_mon_group]

    - name: Adopt manager to cluster
      throttle: 1
      ansible.builtin.command:
        cmd: |
          cephadm adopt --style legacy --name "mgr.{{ item }}"
      loop: groups[ceph_mon_group]

    - name: Ceph mgr module enable cephadm
      ansible.builtin.command: cephadm shell -- ceph mgr module enable cephadm

    - name: Ceph orch set backend cephadm
      ansible.builtin.command: cephadm shell -- ceph orch set backend cephadm

    - name: Use `cephadm` user for cephadm
      ansible.builtin.command: cephadm shell -- ceph cephadm set-user cephadm

    - name: Ceph cephadm generate-key
      ansible.builtin.command: cephadm shell -- ceph cephadm generate-key

- name: Validate monitor adoption
  ansible.builtin.command: cephadm shell -- ceph orch ps
  register: ps_result
  until: >
    "mon.{{ inventory_hostname_short }}" in ps_result.stdout
  retries: 120
  delay: 5
  changed_when: false
  failed_when: ps_result.rc > 1
